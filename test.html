<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecologic</title>

    <!-- deps sesuai basismu -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
      integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>

    <!-- pakai CSS global kamu -->
    <link rel="stylesheet" href="./style/global.css" />

    <!-- tambahan kecil khusus overlay -->
    <style>
      .floating_card {
        position: fixed;
        width: 1px;
        height: 1px;
        border-radius: 20px;
        pointer-events: none;
        z-index: 100;
        display: none;
        will-change: transform, width, height, border-radius, opacity,
          background-color;
      }
    </style>
  </head>
  <body>
    <div class="main_ctr">
      <div class="floating_card"></div>

      <div class="card_ctr">
        <div class="card" style="background-color: red"></div>
        <div class="card" style="background-color: blue"></div>
        <div class="card" style="background-color: green"></div>
        <div class="card" style="background-color: greenyellow"></div>
        <div class="card" style="background-color: bisque"></div>
        <div class="card" style="background-color: blueviolet"></div>
      </div>
    </div>

    <script>
      $(function () {
        let busy = false;

        // Helper: ambil rect semua kartu (left/top/width/height)
        function getRects($items) {
          const rects = new Map();
          $items.each(function () {
            rects.set(this, this.getBoundingClientRect());
          });
          return rects;
        }

        // Helper: paksa reflow
        function reflow(el) {
          void el.offsetWidth;
        }

        $('.card').on('click', function () {
          if (busy) return;
          busy = true;

          const $card = $(this);
          const $all = $('.card');
          const clickedIdx = $all.index($card);

          // ==== 1) Measure BEFORE ====
          const before = getRects($all);

          // ==== 2) Siapkan overlay berdasar kartu terpilih ====
          const cardRect = $card[0].getBoundingClientRect();
          const bgColor = $card.css('background-color');
          const $overlay = $('.floating_card').css({
            display: 'block',
            backgroundColor: bgColor,
            borderRadius: getComputedStyle($card[0]).borderRadius,
          });
          gsap.set($overlay[0], {
            x: cardRect.left,
            y: cardRect.top,
            width: cardRect.width,
            height: cardRect.height,
            opacity: 1,
          });

          // ==== 3) Simulasikan FINAL untuk hitung AFTER (FLIP) ====
          // Kunci nilai saat ini supaya anim shrink tidak "lompat"
          const originalInline = {
            width: $card[0].style.width,
            minWidth: $card[0].style.minWidth,
            paddingLeft: $card[0].style.paddingLeft,
            paddingRight: $card[0].style.paddingRight,
            opacity: $card[0].style.opacity,
          };

          // Set final layout SEBENTAR untuk pengukuran AFTER
          $card.css({
            width: '0px',
            minWidth: '0px',
            paddingLeft: 0,
            paddingRight: 0,
            opacity: 0.6,
          });
          reflow($card[0]); // paksa layout menghitung ulang
          const after = getRects($all.not($card)); // hanya kartu lain yang bergerak

          // Kembalikan visual ke kondisi awal (agar kita bisa animasikan)
          $card.css(originalInline);
          reflow($card[0]);

          // ==== 4) Animasi dorong + benturan untuk setiap kartu lain (FLIP) ====
          const baseDur = 0.48; // durasi fase menuju posisi baru
          const recoilDur = 0.16; // durasi pantulan kecil
          const overshoot = 8; // px, besaran benturan
          const staggerStep = 0.09; // s per jarak index

          $all.each(function (i) {
            const el = this;
            if (el === $card[0]) return;

            const r0 = before.get(el); // posisi awal
            const r1 = after.get(el); // posisi akhir (dari simulasi)
            const dx = (r0 ? r0.left : 0) - (r1 ? r1.left : 0);

            // arah overshoot: mengikuti arah pergeseran
            const dir = dx > 0 ? -1 : 1;
            const delay = Math.abs(i - clickedIdx) * staggerStep;

            // Set posisi awal transform agar tidak "loncat"
            gsap.set(el, {x: dx});

            // Timeline per kartu: menuju posisi → overshoot → kembali
            const tl = gsap.timeline({defaults: {ease: 'power3.out'}, delay});
            tl.to(el, {x: 0, duration: baseDur})
              .to(el, {
                x: dir * overshoot,
                duration: recoilDur,
                ease: 'power2.out',
              })
              .to(el, {x: 0, duration: recoilDur, ease: 'power2.inOut'});
          });

          // ==== 5) Jalankan anim shrink kartu terpilih + overlay expand secara sinkron ====
          const expandDelay = 0.12; // overlay mulai sedikit setelah dorongan mulai agar “impact” kebaca

          // Kartu terpilih: shrink width → 0 (mendorong layout)
          gsap.to($card, {
            width: '0px',
            minWidth: '0px',
            paddingLeft: 0,
            paddingRight: 0,
            opacity: 0.6,
            duration: 0.6,
            ease: 'power2.inOut',
            onComplete() {
              // hapus kartu setelah ruangnya benar2 0
              $card.remove();
            },
          });

          // Overlay: expand jadi background lalu fade-out
          const ovTl = gsap.timeline({
            defaults: {ease: 'power2.inOut'},
            delay: expandDelay,
            onComplete() {
              $overlay.css({display: 'none'}).removeAttr('style');
              busy = false;
            },
          });
          ovTl
            .to($overlay, {
              x: 0,
              y: 0,
              width: window.innerWidth,
              height: window.innerHeight,
              borderRadius: 0,
              duration: 0.75,
            })
            .to($overlay, {opacity: 0, duration: 0.42}, '>-0.1');
        });
      });
    </script>
  </body>
</html>
